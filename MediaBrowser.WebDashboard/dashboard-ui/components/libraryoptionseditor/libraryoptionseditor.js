define(["globalize","dom","emby-checkbox","emby-select","emby-input"],function(globalize,dom){"use strict";function populateLanguages(select){return ApiClient.getCultures().then(function(languages){var html="";html+="<option value=''></option>";for(var i=0,length=languages.length;i<length;i++){var culture=languages[i];html+="<option value='"+culture.TwoLetterISOLanguageName+"'>"+culture.DisplayName+"</option>"}select.innerHTML=html})}function populateCountries(select){return ApiClient.getCountries().then(function(allCountries){var html="";html+="<option value=''></option>";for(var i=0,length=allCountries.length;i<length;i++){var culture=allCountries[i];html+="<option value='"+culture.TwoLetterISORegionName+"'>"+culture.DisplayName+"</option>"}select.innerHTML=html})}function populateRefreshInterval(select){var html="";html+="<option value='0'>"+globalize.translate("Never")+"</option>",html+=[30,60,90].map(function(val){return"<option value='"+val+"'>"+globalize.translate("EveryNDays",val)+"</option>"}).join(""),select.innerHTML=html}function renderMetadataReaders(page,plugins){var html="";if(plugins.length<2)return page.querySelector(".metadataReaders").classList.add("hide"),!1;html+='<h3 class="checkboxListLabel">'+globalize.translate("LabelMetadataReaders")+"</h3>",html+='<div class="checkboxList paperList checkboxList-paperList">';for(var i=0,length=plugins.length;i<length;i++){var plugin=plugins[i];html+='<div class="listItem localReaderOption" data-pluginname="'+plugin.Name+'">',html+='<i class="listItemIcon md-icon">live_tv</i>',html+='<div class="listItemBody">',html+='<h3 class="listItemBodyText">',html+=plugin.Name,html+="</h3>",html+="</div>",i>0?html+='<button type="button" is="paper-icon-button-light" title="'+globalize.translate("ButtonUp")+'" class="btnLocalReaderUp btnLocalReaderMove" data-pluginindex="'+i+'"><i class="md-icon">keyboard_arrow_up</i></button>':plugins.length>1&&(html+='<button type="button" is="paper-icon-button-light" title="'+globalize.translate("ButtonDown")+'" class="btnLocalReaderDown btnLocalReaderMove" data-pluginindex="'+i+'"><i class="md-icon">keyboard_arrow_down</i></button>'),html+="</div>"}return html+="</div>",html+='<div class="fieldDescription">'+globalize.translate("LabelMetadataReadersHelp")+"</div>",page.querySelector(".metadataReaders").innerHTML=html,!0}function renderMetadataSavers(page,metadataSavers){var html="";if(!metadataSavers.length)return page.querySelector(".metadataSavers").classList.add("hide"),!1;html+='<h3 class="checkboxListLabel">'+globalize.translate("LabelMetadataSavers")+"</h3>",html+='<div class="checkboxList paperList checkboxList-paperList">';for(var i=0,length=metadataSavers.length;i<length;i++){var plugin=metadataSavers[i];html+='<label><input type="checkbox" data-defaultenabled="'+plugin.DefaultEnabled+'" is="emby-checkbox" class="chkMetadataSaver" data-pluginname="'+plugin.Name+'" '+!1+"><span>"+plugin.Name+"</span></label>"}return html+="</div>",html+='<div class="fieldDescription" style="margin-top:.25em;">'+globalize.translate("LabelMetadataSaversHelp")+"</div>",page.querySelector(".metadataSavers").innerHTML=html,!0}function populateMetadataSettings(parent,contentType){return ApiClient.getJSON(ApiClient.getUrl("Libraries/AvailableOptions",{LibraryContentType:contentType})).then(function(availableOptions){parent.availableOptions=availableOptions;var hasSavers=renderMetadataSavers(parent,availableOptions.MetadataSavers),hasReaders=renderMetadataReaders(parent,availableOptions.MetadataReaders);hasSavers||hasReaders?parent.querySelector(".metadataSection").classList.remove("hide"):parent.querySelector(".metadataSection").classList.add("hide")}).catch(function(){return Promise.resolve()})}function adjustLocalReaderListElement(elem){var btnLocalReaderMove=elem.querySelector(".btnLocalReaderMove");elem.previousSibling?(btnLocalReaderMove.classList.add("btnLocalReaderUp"),btnLocalReaderMove.classList.remove("btnLocalReaderDown"),btnLocalReaderMove.querySelector("i").innerHTML="keyboard_arrow_up"):(btnLocalReaderMove.classList.remove("btnLocalReaderUp"),btnLocalReaderMove.classList.add("btnLocalReaderDown"),btnLocalReaderMove.querySelector("i").innerHTML="keyboard_arrow_down")}function bindEvents(parent){parent.querySelector(".metadataReaders").addEventListener("click",function(e){var btnLocalReaderMove=dom.parentWithClass(e.target,"btnLocalReaderMove");if(btnLocalReaderMove){var li=dom.parentWithClass(btnLocalReaderMove,"localReaderOption"),list=dom.parentWithClass(li,"paperList");if(btnLocalReaderMove.classList.contains("btnLocalReaderDown")){var next=li.nextSibling;next&&(li.parentNode.removeChild(li),next.parentNode.insertBefore(li,next.nextSibling))}else{var prev=li.previousSibling;prev&&(li.parentNode.removeChild(li),prev.parentNode.insertBefore(li,prev))}Array.prototype.forEach.call(list.querySelectorAll(".localReaderOption"),adjustLocalReaderListElement)}})}function embed(parent,contentType,libraryOptions){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET","components/libraryoptionseditor/libraryoptionseditor.template.html",!0),xhr.onload=function(e){var template=this.response;parent.innerHTML=globalize.translateDocument(template),populateRefreshInterval(parent.querySelector("#selectAutoRefreshInterval"));var promises=[populateLanguages(parent.querySelector("#selectLanguage")),populateCountries(parent.querySelector("#selectCountry")),populateMetadataSettings(parent,contentType)];Promise.all(promises).then(function(){setContentType(parent,contentType),libraryOptions&&setLibraryOptions(parent,libraryOptions),bindEvents(parent),resolve()})},xhr.send()})}function setContentType(parent,contentType){"homevideos"===contentType||"photos"===contentType?(parent.querySelector(".chkEnablePhotosContainer").classList.remove("hide"),parent.querySelector(".chkDownloadImagesInAdvanceContainer").classList.add("hide"),parent.querySelector(".chkEnableInternetProvidersContainer").classList.add("hide"),parent.querySelector(".fldMetadataLanguage").classList.add("hide"),parent.querySelector(".fldMetadataCountry").classList.add("hide"),parent.querySelector(".fldAutoRefreshInterval").classList.add("hide")):(parent.querySelector(".chkEnablePhotosContainer").classList.add("hide"),parent.querySelector(".chkDownloadImagesInAdvanceContainer").classList.remove("hide"),parent.querySelector(".chkEnableInternetProvidersContainer").classList.remove("hide"),parent.querySelector(".fldMetadataLanguage").classList.remove("hide"),parent.querySelector(".fldMetadataCountry").classList.remove("hide"),parent.querySelector(".fldAutoRefreshInterval").classList.remove("hide")),"photos"===contentType?parent.querySelector(".chkSaveLocalContainer").classList.add("hide"):parent.querySelector(".chkSaveLocalContainer").classList.remove("hide"),"tvshows"!==contentType&&"movies"!==contentType&&"homevideos"!==contentType&&"musicvideos"!==contentType&&"mixed"!==contentType&&contentType?parent.querySelector(".chapterSettingsSection").classList.add("hide"):parent.querySelector(".chapterSettingsSection").classList.remove("hide"),"tvshows"===contentType?(parent.querySelector(".chkImportMissingEpisodesContainer").classList.remove("hide"),parent.querySelector(".chkAutomaticallyGroupSeriesContainer").classList.remove("hide"),parent.querySelector(".fldSeasonZeroDisplayName").classList.remove("hide"),parent.querySelector("#txtSeasonZeroName").setAttribute("required","required")):(parent.querySelector(".chkImportMissingEpisodesContainer").classList.add("hide"),parent.querySelector(".chkAutomaticallyGroupSeriesContainer").classList.add("hide"),parent.querySelector(".fldSeasonZeroDisplayName").classList.add("hide"),parent.querySelector("#txtSeasonZeroName").removeAttribute("required")),"games"===contentType||"books"===contentType?parent.querySelector(".chkEnableEmbeddedTitlesContainer").classList.add("hide"):parent.querySelector(".chkEnableEmbeddedTitlesContainer").classList.remove("hide")}function getLibraryOptions(parent){var options={EnableArchiveMediaFiles:!1,EnablePhotos:parent.querySelector(".chkEnablePhotos").checked,EnableRealtimeMonitor:parent.querySelector(".chkEnableRealtimeMonitor").checked,ExtractChapterImagesDuringLibraryScan:parent.querySelector(".chkExtractChaptersDuringLibraryScan").checked,EnableChapterImageExtraction:parent.querySelector(".chkExtractChapterImages").checked,DownloadImagesInAdvance:parent.querySelector("#chkDownloadImagesInAdvance").checked,EnableInternetProviders:parent.querySelector("#chkEnableInternetProviders").checked,ImportMissingEpisodes:parent.querySelector("#chkImportMissingEpisodes").checked,SaveLocalMetadata:parent.querySelector("#chkSaveLocal").checked,EnableAutomaticSeriesGrouping:parent.querySelector(".chkAutomaticallyGroupSeries").checked,PreferredMetadataLanguage:parent.querySelector("#selectLanguage").value,MetadataCountryCode:parent.querySelector("#selectCountry").value,SeasonZeroDisplayName:parent.querySelector("#txtSeasonZeroName").value,AutomaticRefreshIntervalDays:parseInt(parent.querySelector("#selectAutoRefreshInterval").value),EnableEmbeddedTitles:parent.querySelector("#chkEnableEmbeddedTitles").checked,EnabledMetadataSavers:Array.prototype.map.call(Array.prototype.filter.call(parent.querySelectorAll(".chkMetadataSaver"),function(elem){return elem.checked}),function(elem){return elem.getAttribute("data-pluginname")})};return options.LocalMetadataReaderOrder=Array.prototype.map.call(parent.querySelectorAll(".localReaderOption"),function(elem){return elem.getAttribute("data-pluginname")}),options}function getOrderedReaders(readers,configuredOrder){return readers=readers.slice(0),readers.sort(function(a,b){return a=configuredOrder.indexOf(a.Name),b=configuredOrder.indexOf(b.Name),a<b?-1:a>b?1:0}),readers}function setLibraryOptions(parent,options){parent.querySelector("#selectLanguage").value=options.PreferredMetadataLanguage||"",parent.querySelector("#selectCountry").value=options.MetadataCountryCode||"",parent.querySelector("#selectAutoRefreshInterval").value=options.AutomaticRefreshIntervalDays||"0",parent.querySelector("#txtSeasonZeroName").value=options.SeasonZeroDisplayName||"Specials",parent.querySelector(".chkEnablePhotos").checked=options.EnablePhotos,parent.querySelector(".chkEnableRealtimeMonitor").checked=options.EnableRealtimeMonitor,parent.querySelector(".chkExtractChaptersDuringLibraryScan").checked=options.ExtractChapterImagesDuringLibraryScan,parent.querySelector(".chkExtractChapterImages").checked=options.EnableChapterImageExtraction,parent.querySelector("#chkDownloadImagesInAdvance").checked=options.DownloadImagesInAdvance,parent.querySelector("#chkEnableInternetProviders").checked=options.EnableInternetProviders,parent.querySelector("#chkSaveLocal").checked=options.SaveLocalMetadata,parent.querySelector("#chkImportMissingEpisodes").checked=options.ImportMissingEpisodes,parent.querySelector(".chkAutomaticallyGroupSeries").checked=options.EnableAutomaticSeriesGrouping,parent.querySelector("#chkEnableEmbeddedTitles").checked=options.EnableEmbeddedTitles,Array.prototype.forEach.call(parent.querySelectorAll(".chkMetadataSaver"),function(elem){elem.checked=options.EnabledMetadataSavers?-1!==options.EnabledMetadataSavers.indexOf(elem.getAttribute("data-pluginname")):"true"===elem.getAttribute("data-defaultenabled")}),renderMetadataReaders(parent,getOrderedReaders(parent.availableOptions.MetadataReaders,options.LocalMetadataReaderOrder||[]))}return{embed:embed,setContentType:setContentType,getLibraryOptions:getLibraryOptions,setLibraryOptions:setLibraryOptions}});